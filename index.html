<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Sener Fl√§chenberechnung</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#28a745" />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="./Symbol-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./Symbol-512.png" />
  <link rel="apple-touch-icon" href="./Apple-Touch-Symbol.png" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Sener Fl√§che" />

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background:#121212;color:#fff;line-height:1.6}
    .container{max-width:520px;margin:20px auto;padding:20px;background:#1e1e1e;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.5)}
    h1{text-align:center;font-size:1.5em;margin:10px 0 0;padding-bottom:10px;border-bottom:2px solid #007bff}
    .app-logo{display:block;margin:0 auto 10px;max-width:120px;height:auto}

    .tabs{display:flex;justify-content:space-between;margin-bottom:20px;gap:6px}
    .tab-button{flex:1;padding:12px;background:#6c757d;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:700;transition:.2s;user-select:none}
    .tab-button.active{background:#28a745}
    .tab-button:hover{background:#5a6268}
    .tab-button.dragging{opacity:.9;transform:scale(1.05);box-shadow:0 4px 10px rgba(0,0,0,.7);z-index:10}
    .tab-button.drag-over{outline:2px dashed #fff}

    .tab-content{display:none}
    .tab-content.active{display:block}

    .section{background:#252525;padding:16px;margin-top:20px;border-radius:8px;box-shadow:inset 0 0 6px rgba(0,0,0,.3)}
    label{display:block;margin-top:12px;font-weight:700;color:#ccc;font-size:.95em}
    input[type="number"],select,input[type="text"]{width:100%;padding:12px;margin-top:6px;background:#333;color:#fff;border:1px solid #555;border-radius:6px;font-size:16px;box-sizing:border-box}
    button{width:100%;padding:14px;margin-top:16px;background:#28a745;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:700;transition:.2s}
    button:hover{background:#218838}
    .icon{margin-right:8px}

    .result{margin-top:20px;padding:16px;background:#252525;border-radius:8px}
    .result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-top:10px}
    .result-item{text-align:center;padding:10px;background:#333;border-radius:6px}
    .result-label{display:block;font-size:.9em;color:#aaa;margin-bottom:5px}
    .result-value{font-size:1.2em;font-weight:700;color:#28a745}

    .popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;justify-content:center;align-items:center;padding:20px;box-sizing:border-box}
    .popup-content{background:#1e1e1e;border-radius:12px;width:90%;max-width:500px;max-height:90vh;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.5);display:flex;flex-direction:column}
    .popup-header{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #333}
    .popup-header span{font-size:1.2em;font-weight:700}
    .close-btn{background:none;border:none;color:#fff;font-size:1.8em;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center}
    .close-btn:hover{background:rgba(255,255,255,.2);border-radius:50%}
    .popup-body{padding:16px;overflow-y:auto;flex-grow:1}

    .history-item{display:flex;justify-content:space-between;align-items:center;padding:12px;margin:5px 0;background:#252525;border-radius:6px}
    .history-info{flex-grow:1;padding-right:10px}
    .history-time{font-size:.85em;color:#aaa;margin-top:4px}
    .history-input{font-size:.9em;color:#888;margin-top:2px}
    .history-delete{background:none;border:none;color:#ff5555;font-size:1.5em;cursor:pointer;width:auto;padding:6px 10px;margin-top:0}
    .empty-history{padding:30px;text-align:center;color:#888}

    .raum-item{padding:10px;margin:5px 0;background:#252525;border-radius:6px;display:flex;justify-content:space-between;align-items:center}
    .raum-name{font-weight:700}
    .raum-flaeche{font-weight:700;color:#28a745}
    .raum-delete{background:none;border:none;color:#ff5555;font-size:1.2em;cursor:pointer;width:auto;padding:6px 10px;margin-top:0}

    .total-flaeche{margin-top:20px;padding:10px;background:#333;border-radius:6px;display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:1.2em}
    .total-value{color:#28a745}

    .speichern-button{background:#28a745}
    .historie-button{background:#6c757d}
    .historie-button:hover{background:#5a6268}

    #versandMenu{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    #versandMenu .versand-item{background:#2f2f2f;padding:14px;font-size:14px;border-radius:6px;border:none;color:#fff;font-weight:700;text-align:center;width:100%;margin-top:0}
    #versandMenu .versand-item:hover{background:#404040}

    .flaeche-header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .optionen-icon-btn{width:auto;padding:6px 10px;margin-top:0;background:#007bff;border-radius:20px;font-size:.9em;white-space:nowrap}

    #optionenPopup .popup-content{max-width:420px}
    #optionenPopup input,#optionenPopup select{width:100%;margin-bottom:12px;padding:10px;background:#2b2b2b;color:#fff;border:1px solid #444;border-radius:6px;box-sizing:border-box}
    .popup-section{margin-top:20px;font-size:15px;border-left:4px solid #28a745;padding-left:8px}
    .popup-save-btn{width:100%;padding:12px;background:#28a745;color:#fff;border:none;border-radius:6px;font-size:17px;margin-top:10px}
  </style>
</head>

<body>
  <div class="container">
    <!-- Logo: erst logo.png, wenn fehlt automatisch Symbol-512.png -->
    <img src="./logo.png" alt="Sener Logo" class="app-logo" onerror="this.onerror=null;this.src='./Symbol-512.png';" />
    <h1>Sener Fl√§chenberechnung</h1>

    <div class="tabs" id="tabsContainer">
      <button class="tab-button active" data-tab="winkel" onclick="zeigeTab('winkel', event)">Winkel</button>
      <button class="tab-button" data-tab="dreieck" onclick="zeigeTab('dreieck', event)">Dreieck</button>
      <button class="tab-button" data-tab="kreis" onclick="zeigeTab('kreis', event)">Kreis</button>
      <button class="tab-button" data-tab="flaeche" onclick="zeigeTab('flaeche', event)">Fl√§che</button>
    </div>

    <!-- WINKEL -->
    <div id="winkel" class="tab-content active">
      <div class="section">
        <label for="istMasse">Gemessene Ma√üe in mm</label>
        <input type="number" id="istMasse" placeholder="z.B. 4500" inputmode="numeric" />

        <label for="bereich">Bereich:</label>
        <select id="bereich">
          <option value="metallbau" selected>Metallbau (3-4-5) Berechnung</option>
          <option value="wohnungsbau">Wohnungsbau (mittel)</option>
          <option value="agrar">Landbau (genau)</option>
        </select>

        <button onclick="berechneMassen()"><span class="icon">üìê</span> Berechnen</button>
        <button class="historie-button" onclick="oeffneWinkelHistorie()"><span class="icon">üìú</span> Historie Winkel</button>
        <button class="historie-button" onclick="zeige3erReihe()"><span class="icon">üßÆ</span> 3er-Reihe anzeigen</button>
      </div>

      <div id="ergebnis" class="result" style="display:none;">
        <div class="result-grid">
          <div class="result-item">
            <div style="font-size:0.8em;color:#aaa;">Kathete A<br>(<span id="multiplier">-</span> √ó 3)</div>
            <div class="result-value" id="masseA">-</div>
          </div>
          <div class="result-item">
            <span class="result-label">Kathete B<br>(4er-Seite)</span>
            <div class="result-value" id="masseB">-</div>
          </div>
          <div class="result-item">
            <span class="result-label">Hypotenuse C<br>(5er-Seite)</span>
            <div class="result-value" id="masseC">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DREIECK -->
    <div id="dreieck" class="tab-content">
      <div class="section">
        <label for="seiteA">Seite A (mm):</label>
        <input type="number" id="seiteA" placeholder="z.B. 3000" inputmode="numeric" />
        <label for="seiteB">Seite B (mm):</label>
        <input type="number" id="seiteB" placeholder="z.B. 4000" inputmode="numeric" />
        <label for="winkelGamma">Winkel Œ≥ (Grad):</label>
        <input type="number" id="winkelGamma" placeholder="z.B. 90" inputmode="numeric" />
        <button onclick="berechneDreieck()"><span class="icon">üìê</span> Berechnen</button>
      </div>

      <div id="ergebnisDreieck" class="result" style="display:none;">
        <div class="result-grid">
          <div class="result-item">
            <span class="result-label">Seite C (mm)</span>
            <span class="result-value" id="seiteC">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">Fl√§che (m¬≤)</span>
            <span class="result-value" id="flaecheDreieck">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- KREIS -->
    <div id="kreis" class="tab-content">
      <div class="section">
        <label for="durchmesser">Durchmesser:</label>
        <div style="display:flex; gap:10px;">
          <input type="number" id="durchmesser" placeholder="z.B. 21.3 oder 1000" inputmode="decimal" oninput="updateNormAndCalculate()" />
          <select id="durchmesserEinheit" onchange="updateNormAndCalculate()" style="width:120px; flex-shrink:0; margin-top:6px;">
            <option value="mm">mm</option>
            <option value="m">m</option>
            <option value="zoll">Zoll</option>
          </select>
        </div>

        <label for="rohrNorm">Rohrnorm (NW/DN):</label>
        <select id="rohrNorm" onchange="updateDurchmesserFromNorm()">
          <option value="">W√§hle Norm...</option>
          <option value="6">DN 6 (1/8")</option>
          <option value="8">DN 8 (1/4")</option>
          <option value="10">DN 10 (3/8")</option>
          <option value="15">DN 15 (1/2")</option>
          <option value="20">DN 20 (3/4")</option>
          <option value="25">DN 25 (1")</option>
          <option value="32">DN 32 (1 1/4")</option>
          <option value="40">DN 40 (1 1/2")</option>
          <option value="50">DN 50 (2")</option>
          <option value="65">DN 65 (2 1/2")</option>
          <option value="80">DN 80 (3")</option>
          <option value="90">DN 90 (3 1/2")</option>
          <option value="100">DN 100 (4")</option>
          <option value="125">DN 125 (5")</option>
          <option value="150">DN 150 (6")</option>
          <option value="175">DN 175 (7")</option>
          <option value="200">DN 200 (8")</option>
          <option value="250">DN 250 (10")</option>
          <option value="300">DN 300 (12")</option>
          <option value="350">DN 350 (14")</option>
          <option value="400">DN 400 (16")</option>
          <option value="450">DN 450 (18")</option>
          <option value="500">DN 500 (20")</option>
          <option value="600">DN 600 (24")</option>
          <option value="700">DN 700 (28")</option>
          <option value="800">DN 800 (32")</option>
          <option value="900">DN 900 (36")</option>
          <option value="1000">DN 1000 (40")</option>
        </select>

        <div id="normAnzeige" style="margin-top:10px; color:#aaa; font-size:0.9em;"></div>
        <button onclick="berechneKreis()"><span class="icon">‚≠ï</span> Berechnen</button>
      </div>

      <div id="ergebnisKreis" class="result" style="display:none;">
        <div class="result-grid">
          <div class="result-item">
            <span class="result-label">Umfang</span>
            <span class="result-value" id="umfangKreis">-</span>
          </div>
          <div class="result-item">
            <span class="result-label">Fl√§che (m¬≤)</span>
            <span class="result-value" id="flaecheKreis">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- FL√ÑCHE -->
    <div id="flaeche" class="tab-content">
      <div class="section">

        <div style="display:none;">
          <select id="ueberschriftSelect">
            <option value="Wohnung" selected>Wohnung</option>
            <option value="Lager">Lager</option>
            <option value="Halle">Halle</option>
            <option value="B√ºro">B√ºro</option>
            <option value="Agrar">Agrar</option>
            <option value="Au√üenfl√§che">Au√üenfl√§che</option>
            <option value="Sonstige">Sonstige‚Ä¶</option>
          </select>
          <input type="text" id="ueberschriftCustom" />
          <input type="text" id="adresseStrasse" />
          <input type="text" id="adressePLZ" />
          <input type="text" id="adresseOrt" />
          <input type="text" id="beschreibung" />
        </div>

        <div class="flaeche-header-row">
          <h3>Fl√§chenberechnung</h3>
          <button class="optionen-icon-btn" onclick="oeffneOptionenPopup()">‚öôÔ∏è Optionen</button>
        </div>

        <label for="raumName">Raumname:</label>
        <input type="text" id="raumName" placeholder="z.B. Wohnzimmer" />

        <label for="laenge">L√§nge:</label>
        <div style="display:flex; gap:10px;">
          <input type="number" id="laenge" placeholder="z.B. 5.5" inputmode="decimal" />
          <select id="laengeEinheit" style="width:120px; flex-shrink:0; margin-top:6px;">
            <option value="m">m</option>
            <option value="cm">cm</option>
            <option value="mm">mm</option>
          </select>
        </div>

        <label for="breite">Breite:</label>
        <div style="display:flex; gap:10px;">
          <input type="number" id="breite" placeholder="z.B. 4.2" inputmode="decimal" />
          <select id="breiteEinheit" style="width:120px; flex-shrink:0; margin-top:6px;">
            <option value="m">m</option>
            <option value="cm">cm</option>
            <option value="mm">mm</option>
          </select>
        </div>

        <button onclick="berechneFlaeche()"><span class="icon">‚ûï</span> Raum hinzuf√ºgen</button>

        <div id="ergebnisFlaeche" class="result">
          <h3>Gespeicherte R√§ume</h3>
          <div id="raumListe" style="max-height:250px; overflow-y:auto;"></div>

          <div style="margin-top:15px;">
            <label for="flaechenEinheitAnzeige">Fl√§cheneinheit (Anzeige):</label>
            <select id="flaechenEinheitAnzeige" onchange="aktualisiereFlaechenAnzeige()">
              <option value="m2" selected>Quadratmeter (m¬≤)</option>
              <option value="ha">Hektar (ha)</option>
            </select>
          </div>

          <div id="gesamtFlaecheDiv" class="total-flaeche" style="display:none;">
            <span>Gesamtfl√§che:</span>
            <span class="total-value" id="totalFlaeche">0 m¬≤</span>
          </div>

          <button class="speichern-button" onclick="speichereBerechnung()"><span class="icon">üíæ</span> Berechnung speichern</button>

          <button class="historie-button" onclick="oeffneFlaecheHistorie()" style="margin-top:15px;">
            <span class="icon">üìú</span> Historie der Fl√§chenberechnungen
          </button>

          <button class="historie-button" onclick="toggleVersandMenu(event)" style="margin-top:15px;">
            <span class="icon">üì§</span> Versenden
          </button>

          <div id="versandMenu" style="display:none; border-top:1px solid #333; padding-top:10px;">
            <button class="versand-item" onclick="druckeErgebnisse()">üñ®Ô∏è Drucken (Browser)</button>
            <button class="versand-item" onclick="erstelleUndOeffnePDF()">üìÑ Als PDF speichern / versenden</button>
            <button class="versand-item" onclick="versendePerWhatsApp()">üí¨ Per WhatsApp versenden</button>
            <button class="versand-item" onclick="versendeErgebnisse()">üìß Per E-Mail versenden</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- POPUPS -->
  <div id="winkelHistoriePopup" class="popup">
    <div class="popup-content">
      <div class="popup-header">
        <span>Historie der Winkelberechnungen</span>
        <button class="close-btn" onclick="schliesseWinkelHistorie(event)">√ó</button>
      </div>
      <div class="popup-body"><div id="winkelHistoryListe"></div></div>
    </div>
  </div>

  <div id="flaecheHistoriePopup" class="popup">
    <div class="popup-content">
      <div class="popup-header">
        <span>Historie der Fl√§chenberechnungen</span>
        <button class="close-btn" onclick="schliesseFlaecheHistorie(event)">√ó</button>
      </div>
      <div class="popup-body"><div id="flaecheHistoryListe"></div></div>
      <div style="padding:16px;border-top:1px solid #333;">
        <button onclick="zurueckZurFlaeche()" style="background:#6c757d;">üîô Zur√ºck</button>
      </div>
    </div>
  </div>

  <div id="popup3er" class="popup">
    <div class="popup-content">
      <div class="popup-header">
        <span>3er-Multiplikatoren (n √ó 3)</span>
        <button class="close-btn" onclick="schliessePopup(event)">√ó</button>
      </div>
      <div class="popup-body"><div id="popupListe"></div></div>
    </div>
  </div>

  <div id="optionenPopup" class="popup">
    <div class="popup-content">
      <div class="popup-header">
        <span>Optionen</span>
        <button class="close-btn" onclick="schliesseOptionenPopup()">√ó</button>
      </div>
      <div class="popup-body">
        <label>Berechnung ‚Äì √úberschrift</label>
        <select id="popupUeberschrift" onchange="togglePopupCustom()">
          <option value="Wohnung">Wohnung</option>
          <option value="Lager">Lager</option>
          <option value="Halle">Halle</option>
          <option value="B√ºro">B√ºro</option>
          <option value="Agrar">Agrar</option>
          <option value="Au√üenfl√§che">Au√üenfl√§che</option>
          <option value="Sonstige">Sonstige‚Ä¶</option>
        </select>
        <input type="text" id="popupUeberschriftCustom" placeholder="Eigene Bezeichnung‚Ä¶" style="display:none; margin-top:8px;" />

        <h4 class="popup-section">Adresse</h4>
        <label>Stra√üe / Nr:</label>
        <input type="text" id="popupStrasse" placeholder="Musterstra√üe 12" />
        <label>PLZ:</label>
        <input type="text" id="popupPLZ" placeholder="12345" inputmode="numeric" />
        <label>Ort:</label>
        <input type="text" id="popupOrt" placeholder="M√ºlheim an der Ruhr" />

        <h4 class="popup-section">Beschreibung / Messung</h4>
        <input type="text" id="popupBeschreibung" placeholder="z.B. Wohnung 1. OG links" />

        <button class="popup-save-btn" onclick="speichereOptionen()">‚úîÔ∏è √úbernehmen</button>
      </div>
    </div>
  </div>

  <script>
    let berechnungsHistorie = JSON.parse(localStorage.getItem('sener_historie')) || [];
    let berechnungHistorie = JSON.parse(localStorage.getItem('sener_berechnung_historie')) || [];
    let raeume = [];
    let draggedTab = null;

    const normen = [
      { nw: "6", zoll: "1/8\"", iso: 10.2, ansi: 10.5 }, { nw: "8", zoll: "1/4\"", iso: 13.5, ansi: 13.72 },
      { nw: "10", zoll: "3/8\"", iso: 17.2, ansi: 17.15 }, { nw: "15", zoll: "1/2\"", iso: 21.3, ansi: 21.34 },
      { nw: "20", zoll: "3/4\"", iso: 26.9, ansi: 26.67 }, { nw: "25", zoll: "1\"", iso: 33.7, ansi: 33.40 },
      { nw: "32", zoll: "1 1/4\"", iso: 42.4, ansi: 42.16 }, { nw: "40", zoll: "1 1/2\"", iso: 48.3, ansi: 48.26 },
      { nw: "50", zoll: "2\"", iso: 60.3, ansi: 60.33 }, { nw: "65", zoll: "2 1/2\"", iso: 76.1, ansi: 73.03 },
      { nw: "80", zoll: "3\"", iso: 88.9, ansi: 88.90 }, { nw: "90", zoll: "3 1/2\"", iso: 101.6, ansi: 101.60 },
      { nw: "100", zoll: "4\"", iso: 114.3, ansi: 114.30 }, { nw: "125", zoll: "5\"", iso: 139.7, ansi: 141.30 },
      { nw: "150", zoll: "6\"", iso: 168.3, ansi: 168.28 }, { nw: "175", zoll: "7\"", iso: 193.7, ansi: 193.70 },
      { nw: "200", zoll: "8\"", iso: 219.1, ansi: 219.08 }, { nw: "250", zoll: "10\"", iso: 273.0, ansi: 273.05 },
      { nw: "300", zoll: "12\"", iso: 323.9, ansi: 323.85 }, { nw: "350", zoll: "14\"", iso: 355.6, ansi: 355.60 },
      { nw: "400", zoll: "16\"", iso: 406.4, ansi: 406.40 }, { nw: "450", zoll: "18\"", iso: 457.2, ansi: 457.20 },
      { nw: "500", zoll: "20\"", iso: 508.0, ansi: 508.00 }, { nw: "600", zoll: "24\"", iso: 609.6, ansi: 609.60 },
      { nw: "700", zoll: "28\"", iso: 711.2, ansi: 711.20 }, { nw: "800", zoll: "32\"", iso: 812.8, ansi: 812.80 },
      { nw: "900", zoll: "36\"", iso: 914.4, ansi: 914.40 }, { nw: "1000", zoll: "40\"", iso: 1016.0, ansi: 1016.00 }
    ];

    function initDraggableTabs() {
      const container = document.getElementById('tabsContainer');
      if (!container) return;

      const buttons = Array.from(container.querySelectorAll('.tab-button'));
      const saved = localStorage.getItem('sener_tabs_order');
      if (saved) {
        try {
          const order = JSON.parse(saved);
          const map = {};
          buttons.forEach(b => map[b.dataset.tab] = b);
          order.forEach(id => map[id] && container.appendChild(map[id]));
          buttons.forEach(b => !container.contains(b) && container.appendChild(b));
        } catch {}
      }

      container.querySelectorAll('.tab-button').forEach(btn => {
        btn.setAttribute('draggable', 'true');

        btn.addEventListener('dragstart', (e) => {
          draggedTab = btn;
          btn.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', btn.dataset.tab);
        });

        btn.addEventListener('dragend', () => {
          draggedTab && draggedTab.classList.remove('dragging');
          container.querySelectorAll('.tab-button').forEach(b => b.classList.remove('drag-over'));
          draggedTab = null;
          const order = Array.from(container.querySelectorAll('.tab-button')).map(b => b.dataset.tab);
          localStorage.setItem('sener_tabs_order', JSON.stringify(order));
        });

        btn.addEventListener('dragover', (e) => {
          e.preventDefault();
          if (!draggedTab || draggedTab === btn) return;
          btn.classList.add('drag-over');
          const rect = btn.getBoundingClientRect();
          const insertBefore = (e.clientX - rect.left) < rect.width / 2;
          container.insertBefore(draggedTab, insertBefore ? btn : btn.nextSibling);
        });

        btn.addEventListener('dragleave', () => btn.classList.remove('drag-over'));
        btn.addEventListener('drop', (e) => { e.preventDefault(); btn.classList.remove('drag-over'); });
      });
    }

    function isHaModus(){const sel=document.getElementById('flaechenEinheitAnzeige');return sel&&sel.value==='ha'}
    function formatFlaeche(value){
      if(isNaN(value)) value=0;
      if(isHaModus()){
        const ha=value/10000;
        const f=ha<10?ha.toLocaleString('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}):ha.toLocaleString('de-DE',{minimumFractionDigits:1,maximumFractionDigits:1});
        return `${f} ha`;
      }
      if(value<100) return `${Math.round(value).toLocaleString('de-DE')} m¬≤`;
      if(value<1000) return `${(Math.round(value*10)/10).toLocaleString('de-DE',{minimumFractionDigits:1,maximumFractionDigits:1})} m¬≤`;
      return `${value.toLocaleString('de-DE',{maximumFractionDigits:3})} m¬≤`;
    }

    function aktualisiereFlaechenAnzeige(){zeigeRaumListe();berechneGesamtFlaeche();}

    function zeigeTab(tabName,event){
      event&&event.stopPropagation&&event.stopPropagation();
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      const btn=document.querySelector(`.tab-button[data-tab="${tabName}"]`);
      btn&&btn.classList.add('active');
      if(tabName==='flaeche'){zeigeRaumListe();berechneGesamtFlaeche();}
    }

    function schliesseWinkelHistorie(e){e&&e.stopPropagation&&e.stopPropagation();document.getElementById('winkelHistoriePopup').style.display='none'}
    function schliesseFlaecheHistorie(e){e&&e.stopPropagation&&e.stopPropagation();document.getElementById('flaecheHistoriePopup').style.display='none'}
    function schliessePopup(e){e&&e.stopPropagation&&e.stopPropagation();document.getElementById('popup3er').style.display='none'}
    function zurueckZurFlaeche(){schliesseFlaecheHistorie(null);}

    function zeige3erReihe(){
      const popup=document.getElementById('popup3er');
      const liste=document.getElementById('popupListe');
      const input=document.getElementById('istMasse');
      if(!popup||!liste||!input) return;
      liste.innerHTML='';
      for(let a=300;a<=6900;a+=300){
        const k=a/3,b=k*4,c=k*5;
        const div=document.createElement('div');
        div.className='history-item';
        div.style.cursor='pointer';
        div.innerHTML=`<div class="history-info">
          <div class="raum-name">A: ${a.toLocaleString('de-DE')} mm (K: ${k.toLocaleString('de-DE')} mm)</div>
          <div class="history-time">B: ${b.toLocaleString('de-DE')} mm ¬∑ C: ${c.toLocaleString('de-DE')} mm</div>
          <div class="history-input">Tippen ‚Üí √ºbernimmt Messung</div>
        </div>`;
        div.onclick=()=>{input.value=String(a+300);document.getElementById('bereich').value='metallbau';berechneMassen();popup.style.display='none';};
        liste.appendChild(div);
      }
      popup.style.display='flex';
    }

    function berechneMassen(){
      const raw=document.getElementById('istMasse').value.replace(/,/g,'.').replace(/\s/g,'');
      const ist=parseFloat(raw);
      const bereich=document.getElementById('bereich').value;
      const out=document.getElementById('ergebnis');
      if(isNaN(ist)||ist<300){alert("Bitte g√ºltige Ist-Masse ‚â• 300 mm.");out.style.display='none';return;}
      let a,b,c,k;
      if(bereich==='metallbau'){
        if(ist<600){alert("Metallbau: Ist-Masse ‚â• 600 mm (300 mm Reserve).");out.style.display='none';return;}
        const aMax=Math.floor((ist-300)/300)*300;
        a=Math.min(6900,Math.max(300,aMax));
        k=a/3;
      } else if(bereich==='wohnungsbau'){
        const kk=Math.floor(ist/3/50)*50; k=Math.max(100,kk);
      } else {
        const kk=Math.floor(ist/3/10)*10; k=Math.max(100,kk);
      }
      a=k*3;b=k*4;c=k*5;

      const opt={maximumFractionDigits:0};
      document.getElementById('masseA').textContent=a.toLocaleString('de-DE',opt)+" mm";
      document.getElementById('masseB').textContent=b.toLocaleString('de-DE',opt)+" mm";
      document.getElementById('masseC').textContent=c.toLocaleString('de-DE',opt)+" mm";
      document.getElementById('multiplier').textContent=k.toLocaleString('de-DE',opt);
      out.style.display='block';

      berechnungsHistorie.unshift({id:Date.now(),zeit:new Date().toLocaleString('de-DE'),input:ist,bereich,a,b,c,k});
      if(berechnungsHistorie.length>50) berechnungsHistorie.pop();
      localStorage.setItem('sener_historie',JSON.stringify(berechnungsHistorie));
    }

    function zeigeWinkelHistorie(){
      const liste=document.getElementById('winkelHistoryListe');
      liste.innerHTML='';
      if(berechnungsHistorie.length===0){liste.innerHTML='<p class="empty-history">Keine Winkelberechnungen vorhanden.</p>';return;}
      berechnungsHistorie.forEach(item=>{
        const label=item.bereich==='metallbau'?'Metallbau (3-4-5)':item.bereich==='wohnungsbau'?'Wohnungsbau (mittel)':'Landbau (genau)';
        const div=document.createElement('div');
        div.className='history-item';
        div.innerHTML=`<div class="history-info">
          <div class="raum-name">A: ${item.a.toLocaleString('de-DE',{maximumFractionDigits:0})} mm</div>
          <div class="history-input">Ist: ${item.input.toLocaleString('de-DE',{maximumFractionDigits:0})} mm (${label})</div>
          <div class="history-time">K: ${item.k.toLocaleString('de-DE',{maximumFractionDigits:0})} | B: ${item.b.toLocaleString('de-DE',{maximumFractionDigits:0})} | C: ${item.c.toLocaleString('de-DE',{maximumFractionDigits:0})}</div>
        </div>
        <button class="history-delete" onclick="event.stopPropagation();loescheWinkelHistorie(${item.id})">üóëÔ∏è</button>`;
        liste.appendChild(div);
      });
    }
    function loescheWinkelHistorie(id){berechnungsHistorie=berechnungsHistorie.filter(x=>x.id!==id);localStorage.setItem('sener_historie',JSON.stringify(berechnungsHistorie));zeigeWinkelHistorie();}
    function oeffneWinkelHistorie(){zeigeWinkelHistorie();document.getElementById('winkelHistoriePopup').style.display='flex';}

    function berechneDreieck(){
      const a=parseFloat(document.getElementById('seiteA').value.replace(/,/g,'.'));
      const b=parseFloat(document.getElementById('seiteB').value.replace(/,/g,'.'));
      const g=parseFloat(document.getElementById('winkelGamma').value.replace(/,/g,'.'));
      if(isNaN(a)||isNaN(b)||isNaN(g)||a<=0||b<=0||g<=0||g>=180){alert("Bitte g√ºltige Werte f√ºr A, B und Œ≥ eingeben.");document.getElementById('ergebnisDreieck').style.display='none';return;}
      const gr=g*Math.PI/180;
      const c=Math.sqrt(a*a+b*b-2*a*b*Math.cos(gr));
      const fl=0.5*a*b*Math.sin(gr)/1000000;
      document.getElementById('seiteC').textContent=c.toFixed(2).replace('.',',')+" mm";
      document.getElementById('flaecheDreieck').textContent=fl.toFixed(3).replace('.',',')+" m¬≤";
      document.getElementById('ergebnisDreieck').style.display='block';
    }

    function getDurchmesserInMM(){
      let d=parseFloat(document.getElementById('durchmesser').value.replace(/,/g,'.'));
      const e=document.getElementById('durchmesserEinheit').value;
      if(isNaN(d)) return 0;
      if(e==='zoll') return d*25.4;
      if(e==='m') return d*1000;
      return d;
    }

    function updateNormAndCalculate(){
      const d_mm=getDurchmesserInMM();
      const sel=document.getElementById('rohrNorm');
      const out=document.getElementById('normAnzeige');
      let best=null,dist=Infinity;
      if(d_mm>0){
        for(const n of normen){
          const a=Math.abs(d_mm-n.iso);
          if(a<dist){dist=a;best=n;}
        }
      }
      if(best&&d_mm>0){
        sel.value=best.nw;
        out.innerHTML=`<strong>N√§chste Norm:</strong> NW ${best.nw} (${best.zoll})<br><strong>ISO:</strong> ${best.iso.toFixed(2).replace('.',',')} mm<br><strong>ANSI:</strong> ${best.ansi.toFixed(2).replace('.',',')} mm`;
      } else {
        sel.value=""; out.innerHTML="Keine g√§ngige Norm erkannt.";
      }
      berechneKreis(d_mm);
    }

    function updateDurchmesserFromNorm(){
      const v=document.getElementById('rohrNorm').value;
      const d=document.getElementById('durchmesser');
      const e=document.getElementById('durchmesserEinheit');
      const out=document.getElementById('normAnzeige');
      if(!v){d.value="";out.innerHTML="Keine Norm ausgew√§hlt.";berechneKreis(0);return;}
      const n=normen.find(x=>x.nw===v);
      if(!n) return;
      d.value=n.iso.toFixed(2).replace('.',',');
      e.value='mm';
      out.innerHTML=`<strong>Ausgew√§hlte Norm:</strong> NW ${n.nw} (${n.zoll})<br><strong>ISO:</strong> ${n.iso.toFixed(2).replace('.',',')} mm<br><strong>ANSI:</strong> ${n.ansi.toFixed(2).replace('.',',')} mm`;
      berechneKreis(n.iso);
    }

    function berechneKreis(override){
      const d_mm=(override!==undefined)?override:getDurchmesserInMM();
      if(!d_mm||d_mm<=0){document.getElementById('ergebnisKreis').style.display='none';return;}
      const dm=d_mm/1000;
      const umfang=Math.PI*dm;
      const fl=Math.PI*(dm/2)**2;
      document.getElementById('umfangKreis').textContent=umfang.toLocaleString('de-DE',{minimumFractionDigits:3,maximumFractionDigits:3})+" m";
      document.getElementById('flaecheKreis').textContent=fl.toLocaleString('de-DE',{minimumFractionDigits:3,maximumFractionDigits:3})+" m¬≤";
      document.getElementById('ergebnisKreis').style.display='block';
    }

    function getUeberschrift(){
      const sel=document.getElementById("ueberschriftSelect").value;
      if(sel==="Sonstige") return document.getElementById("ueberschriftCustom").value.trim()||"Unbenannt";
      return sel;
    }
    function getAufmassDaten(){
      return{
        titel:getUeberschrift(),
        strasse:document.getElementById("adresseStrasse").value.trim(),
        plz:document.getElementById("adressePLZ").value.trim(),
        ort:document.getElementById("adresseOrt").value.trim(),
        beschreibung:document.getElementById("beschreibung").value.trim()
      };
    }
    function einheitInMeter(w,e){if(isNaN(w))return 0; if(e==='mm')return w/1000; if(e==='cm')return w/100; return w;}

    function berechneFlaeche(){
      const name=document.getElementById('raumName').value.trim();
      const L=parseFloat(document.getElementById('laenge').value.replace(/,/g,'.'));
      const B=parseFloat(document.getElementById('breite').value.replace(/,/g,'.'));
      const Le=document.getElementById('laengeEinheit').value;
      const Be=document.getElementById('breiteEinheit').value;
      if(!name||isNaN(L)||isNaN(B)||L<=0||B<=0){alert("Bitte Raumnamen sowie g√ºltige L√§nge und Breite eingeben.");return;}
      const fl=einheitInMeter(L,Le)*einheitInMeter(B,Be);
      raeume.unshift({id:Date.now(),name,laenge:L,breite:B,laengeE:Le,breiteE:Be,flaeche:fl});
      zeigeRaumListe();berechneGesamtFlaeche();
      document.getElementById('raumName').value='';document.getElementById('laenge').value='';document.getElementById('breite').value='';
    }

    function loescheRaum(id){raeume=raeume.filter(r=>r.id!==id);zeigeRaumListe();berechneGesamtFlaeche();}
    function zeigeRaumListe(){
      const div=document.getElementById('raumListe'); div.innerHTML='';
      if(raeume.length===0){div.innerHTML='<p class="empty-history">Noch keine R√§ume erfasst.</p>';document.getElementById('gesamtFlaecheDiv').style.display='none';return;}
      raeume.forEach(r=>{
        const el=document.createElement('div'); el.className='raum-item';
        el.innerHTML=`<div style="flex-grow:1;">
            <div class="raum-name">${r.name}</div>
            <div class="history-input">${r.laenge.toFixed(2).replace('.',',')} ${r.laengeE} √ó ${r.breite.toFixed(2).replace('.',',')} ${r.breiteE}</div>
          </div>
          <div class="raum-flaeche">${formatFlaeche(r.flaeche)}</div>
          <div class="raum-actions"><button class="raum-delete" onclick="loescheRaum(${r.id})">üóëÔ∏è</button></div>`;
        div.appendChild(el);
      });
    }

    function berechneGesamtFlaeche(){
      const sum=raeume.reduce((s,r)=>s+r.flaeche,0);
      document.getElementById('totalFlaeche').textContent=formatFlaeche(sum);
      document.getElementById('gesamtFlaecheDiv').style.display=raeume.length?'flex':'none';
      return sum;
    }

    function speichereBerechnung(){
      if(!raeume.length){alert("Es gibt keine R√§ume zum Speichern!");return;}
      const daten=getAufmassDaten();
      const gesamt=berechneGesamtFlaeche();
      berechnungHistorie.unshift({id:Date.now(),zeit:new Date().toLocaleString('de-DE'),daten,raeume:raeume.slice(),gesamt});
      if(berechnungHistorie.length>50) berechnungHistorie.pop();
      localStorage.setItem('sener_berechnung_historie',JSON.stringify(berechnungHistorie));
      alert(`Berechnung "${daten.titel}" gespeichert!`);
    }

    function zeigeFlaecheHistorie(){
      const liste=document.getElementById('flaecheHistoryListe'); liste.innerHTML='';
      if(!berechnungHistorie.length){liste.innerHTML='<p class="empty-history">Keine gespeicherten Fl√§chenberechnungen vorhanden.</p>';return;}
      berechnungHistorie.forEach(item=>{
        const d=item.daten;
        const el=document.createElement('div'); el.className='history-item';
        el.innerHTML=`<div class="history-info" onclick="ladeBerechnung(${item.id})" style="cursor:pointer;">
            <div class="raum-name">${d.titel}</div>
            <div class="raum-flaeche">${formatFlaeche(item.gesamt)}</div>
            <div class="history-time">${item.zeit} (${item.raeume.length} R√§ume)</div>
            <div class="history-input">${d.strasse ? d.strasse + ', ' : ''}${(d.plz || d.ort) ? (d.plz + ' ' + d.ort) : ''}</div>
          </div>
          <button class="history-delete" onclick="event.stopPropagation();loescheBerechnungHistorie(${item.id})">üóëÔ∏è</button>`;
        liste.appendChild(el);
      });
    }
    function loescheBerechnungHistorie(id){berechnungHistorie=berechnungHistorie.filter(x=>x.id!==id);localStorage.setItem('sener_berechnung_historie',JSON.stringify(berechnungHistorie));zeigeFlaecheHistorie();}
    function ladeBerechnung(id){
      const b=berechnungHistorie.find(x=>x.id===id); if(!b) return;
      const d=b.daten;
      const sel=document.getElementById("ueberschriftSelect");
      const cust=document.getElementById("ueberschriftCustom");
      if(["Wohnung","Lager","Halle","B√ºro","Agrar","Au√üenfl√§che"].includes(d.titel)){sel.value=d.titel;cust.value="";} else {sel.value="Sonstige";cust.value=d.titel;}
      document.getElementById("adresseStrasse").value=d.strasse;
      document.getElementById("adressePLZ").value=d.plz;
      document.getElementById("adresseOrt").value=d.ort;
      document.getElementById("beschreibung").value=d.beschreibung;
      raeume=b.raeume.slice(); zeigeRaumListe(); berechneGesamtFlaeche();
      document.getElementById('flaecheHistoriePopup').style.display='none';
      document.getElementById('versandMenu').style.display='none';
      alert(`Berechnung "${d.titel}" geladen!`);
    }
    function oeffneFlaecheHistorie(){zeigeFlaecheHistorie();document.getElementById('flaecheHistoriePopup').style.display='flex';}

    function toggleVersandMenu(e){
      e&&e.stopPropagation&&e.stopPropagation();
      const m=document.getElementById('versandMenu');
      const hidden=m.style.display==='none'||m.style.display==='';
      m.style.display=hidden?'grid':'none';
    }

    function generiereShareText(raumArray,datenOverride){
      const rr=raumArray||raeume;
      const d=datenOverride||getAufmassDaten();
      const ges=rr.reduce((s,r)=>s+r.flaeche,0);
      let t=`Fl√§chenberechnung: ${d.titel}\n`;
      if(d.strasse) t+=`Adresse: ${d.strasse}\n`;
      if(d.plz||d.ort) t+=`${d.plz} ${d.ort}\n`;
      if(d.beschreibung) t+=`Beschreibung: ${d.beschreibung}\n`;
      t+=`\nGesamtfl√§che: ${formatFlaeche(ges)}\n\n`;
      rr.forEach(r=>{t+=`‚Ä¢ ${r.name}: ${formatFlaeche(r.flaeche)} (${r.laenge.toFixed(2).replace('.',',')} ${r.laengeE} √ó ${r.breite.toFixed(2).replace('.',',')} ${r.breiteE})\n`;});
      return t;
    }

    function druckeErgebnisse(){if(!raeume.length){alert("Keine R√§ume zum Drucken vorhanden.");return;}window.print();}
    function versendePerWhatsApp(){if(!raeume.length){alert("Keine R√§ume zum Versenden vorhanden.");return;}window.open(`https://wa.me/?text=${encodeURIComponent(generiereShareText())}`,'_blank');}
    function versendeErgebnisse(){
      if(!raeume.length){alert("Keine R√§ume zum Versenden vorhanden.");return;}
      const d=getAufmassDaten();
      const subject=`Ergebnisse der Fl√§chenberechnung: ${d.titel}`;
      window.location.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(generiereShareText())}`;
    }

    function erstelleUndOeffnePDF(){
      if(!raeume.length){alert("Keine R√§ume zum Erstellen einer PDF vorhanden.");return;}
      if(!window.jspdf||!window.jspdf.jsPDF){alert("jsPDF konnte nicht geladen werden (Internet pr√ºfen).");return;}
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      const d=getAufmassDaten();
      const ges=berechneGesamtFlaeche();
      let y=10,lh=7;
      doc.setFontSize(16); doc.text(`Fl√§chenberechnung: ${d.titel}`,10,y); y+=lh;
      doc.setFontSize(11);
      if(d.strasse){doc.text(`Adresse: ${d.strasse}`,10,y); y+=lh;}
      if(d.plz||d.ort){doc.text(`${d.plz} ${d.ort}`,10,y); y+=lh;}
      if(d.beschreibung){doc.text(`Beschreibung: ${d.beschreibung}`,10,y); y+=lh;}
      y+=lh; doc.setFontSize(12); doc.text(`Gesamtfl√§che: ${formatFlaeche(ges)}`,10,y); y+=lh*2;
      doc.setFontSize(10);
      raeume.forEach(r=>{
        if(y>280){doc.addPage(); y=10;}
        doc.text(`Raum: ${r.name}`,10,y); y+=lh;
        doc.text(`Fl√§che: ${formatFlaeche(r.flaeche)}`,15,y); y+=lh;
        doc.text(`Ma√üe: ${r.laenge.toFixed(2).replace('.',',')} ${r.laengeE} x ${r.breite.toFixed(2).replace('.',',')} ${r.breiteE}`,15,y);
        y+=lh*1.2;
      });
      const name=(d.titel||'Flaechenberechnung').replace(/[^a-z0-9]/gi,'_');
      doc.save(`${name}.pdf`);
    }

    function oeffneOptionenPopup(){
      const titel=getUeberschrift();
      const sel=document.getElementById("popupUeberschrift");
      const custom=document.getElementById("popupUeberschriftCustom");
      if(["Wohnung","Lager","Halle","B√ºro","Agrar","Au√üenfl√§che"].includes(titel)){sel.value=titel;custom.style.display="none";custom.value="";} else {sel.value="Sonstige";custom.style.display="block";custom.value=titel;}
      document.getElementById("popupStrasse").value=document.getElementById("adresseStrasse").value;
      document.getElementById("popupPLZ").value=document.getElementById("adressePLZ").value;
      document.getElementById("popupOrt").value=document.getElementById("adresseOrt").value;
      document.getElementById("popupBeschreibung").value=document.getElementById("beschreibung").value;
      document.getElementById("optionenPopup").style.display="flex";
    }
    function schliesseOptionenPopup(){document.getElementById("optionenPopup").style.display="none";}
    function togglePopupCustom(){document.getElementById("popupUeberschriftCustom").style.display=(document.getElementById("popupUeberschrift").value==="Sonstige"?"block":"none");}
    function speichereOptionen(){
      let titel=document.getElementById("popupUeberschrift").value;
      if(titel==="Sonstige"){
        titel=document.getElementById("popupUeberschriftCustom").value.trim()||"Unbenannt";
        document.getElementById("ueberschriftSelect").value="Sonstige";
        document.getElementById("ueberschriftCustom").value=titel;
      } else {
        document.getElementById("ueberschriftSelect").value=titel;
        document.getElementById("ueberschriftCustom").value="";
      }
      document.getElementById("adresseStrasse").value=document.getElementById("popupStrasse").value;
      document.getElementById("adressePLZ").value=document.getElementById("popupPLZ").value;
      document.getElementById("adresseOrt").value=document.getElementById("popupOrt").value;
      document.getElementById("beschreibung").value=document.getElementById("popupBeschreibung").value;
      schliesseOptionenPopup();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      zeigeTab('winkel',null);
      zeigeRaumListe();
      berechneGesamtFlaeche();
      const menu=document.getElementById('versandMenu'); if(menu) menu.style.display='none';
      const inp=document.getElementById('istMasse'); if(inp) inp.addEventListener('keypress',e=>{if(e.key==='Enter') berechneMassen();});
      initDraggableTabs();
    });

    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .catch(err=>console.log('SW Registrierung fehlgeschlagen:',err));
      });
    }
  </script>
</body>
</html>
